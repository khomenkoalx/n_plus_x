# SQL Query Optimization: N+X Promo Analytics

## Бизнес-задача
Анализ эффективности промо-акций N+X (например, купи 2 товара и получи 1 бесплатно) для фармакодистрибьютора.  

Необходимо рассчитать:  
- Продажи акционного ассортимента попадающего под условия в штуках и "пакетах" в период акции.
- Продажи в контрольный период (равнозначный срок до начала акции).
- Общие продажи акционного ассортимента, включая не попадающий под условия акции.

### Бизнес логика
- Исключение сочетаний ИНН покупателя и товара, для которых в период акции есть такое исключение в `promo_n_plus_x_exception`.  
- Для клиентов с id_client 36 и 37 должны учитываться только продажи, кратные условию акции, для остальных только продажи с количеством больше или равным условию.
- Контрольным периодом считается идентичный период до начала акции.

## Проблемы исходного решения
1. **Производительность**: Первоначально запрос выполнялся в течение 90-120 минут. После индексации время выполнения сократилось до 40-60 минут, что также было неудовлетворительно.  
2. **Поддержка**:  
    - Жестко закодированная бизнес-логика.
    - Дублирование условий.
    - Несколько коррелированных запросов и подзапросов.
    - Сложность восприятия кода.
3. **Масштабируемость**: Невозможно добавить новые метрики без полного переписывания запроса.

## Оптимизированное решение

### Архитектурный подход
1. **Модульная структура**:  
    - `promo_base_info` - базовые параметры акций.
    - `promo_condition_sales` и `total_sales` - продажи, попадающие под условия акции и общие продажи.
    - `combined_sales` - объединенные предыдущие две CTE с соответствующим флагом `sales_type`.
    - `sales_with_packs` - рассчитанное число "пакетов" с учетом специфики для отдельных клиентов.
    - `agg_table` - таблица с агрегированными значениями продаж по каждой акции.
    - `table_without_price` - таблица с расчётом продаж для периода акций, контрольного периода и продаж в целом для каждой акции, а также активной клиентской базы (acb) в каждый период.
2. **Ключевые оптимизации**:  
    - Замена коррелированных подзапросов на CTE.
    - Использование LATERAL JOIN для сложных расчётов.
    - Материализация промежуточных результатов.


### Результаты оптимизации
| Показатель | До | После |  
| -- | -- | -- |
| Время выполнения | 40-60 минут | 20 секунд  |
| Количество JOIN | 20 | 11 |
| Объем кода | 273 строки | 194 строки |
| Читаемость | Низкая, дублирование логики, коррелированные подзапросы | Высокая, модульная структура, CTE, LATERAL JOIN |
| Количество повторений (`loops`) по ключевым операциям | Миллионы | За исключением одной операции везде 1 |
| Полные сканирования таблиц (Seq Scan) | Частые, особенно на dim_sku, fct_sale_second | Минимизированы, заменены на Index Scan / Index Only Scan |


## Контакты
Email - [a.khomenko42@gmail.com](mailto:a.khomenko42@gmail.com)  
Telegram - [@drkhomenko](https://t.me/drkhomenko)


